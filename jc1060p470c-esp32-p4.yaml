esphome:
  name: jc1060p470c-esp32-p4
  friendly_name: JC1060P470C ESP32-P4
  min_version: 2025.10.0
  project:
    name: "Guition.ESP32-P4-JC1060P470"
    version: "1.0"
  on_boot:
    priority: -100
    then:
      - lvgl.resume: {}

esp32:
  board: esp32-p4-evboard
  variant: esp32p4
  flash_size: 16MB
  cpu_frequency: 360MHz
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_SPIRAM_XIP_FROM_PSRAM: y   # To stop the screen flashing during OTA updates
    advanced:
      enable_idf_experimental_features: yes

esp_ldo:
  - channel: 3
    id: dsi_phy_enable
    voltage: 2.5V
    adjustable: True
  - channel: 4
    id: sd_card_power
    voltage: 2.7V
    adjustable: True

psram:
  mode: hex
  speed: 200MHz

# ESP32-C6 Coprocessor for Wi-Fi and Bluetooth
esp32_hosted:
  variant: ESP32C6
  reset_pin: GPIO54
  clk_pin: GPIO18
  cmd_pin: GPIO19
  d0_pin: GPIO14
  d1_pin: GPIO15
  d2_pin: GPIO16
  d3_pin: GPIO17
  active_high: true

# Web server for easy access
web_server:
  port: 80
  auth:
    username: !secret web_server_username
    password: !secret web_server_password

captive_portal:

# Wi-Fi and API
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none
  reboot_timeout: 0s
  ap:
    ssid: "JC1060P470C Fallback"
    password: "12345678"

api:
  encryption:
    key: !secret api_encryption_key
  reboot_timeout: 0s

ota:
  - platform: esphome
    password: !secret ota_password
  - platform: web_server

external_components:
  - source:
      type: local
      path: components

hmi_bms:
  id: bms_hub
  uart_id: uart_bus
  update_interval: 1s
  bypass_crc: false
  baud_rate: 460800
  dump_raw: false

# Scripts to break circular dependencies
interval:
  - interval: 1s
    then:
      - script.execute: update_cells_ui

script:
  - id: update_soc_ui
    parameters:
      val: float
    then:
      - lvgl.arc.update:
          id: soc_arc
          value: !lambda "return val;"
          arc_color: !lambda "return (val > 20) ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);"
      - lvgl.label.update:
          id: label_soc
          text:
            format: "%.0f%%"
            args: [ val ]

  - id: update_voltage_ui
    parameters:
      val: float
    then:
      - lvgl.label.update:
          id: label_voltage
          text:
            format: "%.2f V"
            args: [ val ]

  - id: update_current_ui
    parameters:
      val: float
    then:
      - lvgl.label.update:
          id: label_current
          text:
            format: "%.3f A"
            args: [ val ]

  - id: update_temp_ui
    then:
      - lvgl.label.update:
          id: label_temp
          text:
            format: "%.1f° - %.1f°C"
            args: [ 'id(bms_temp_min).state', 'id(bms_temp_max).state' ]

  - id: update_cells_ui
    then:
      - lvgl.label.update:
          id: label_cells
          text:
            format: "%.3f - %.3f V"
            args: [ 'id(bms_cell_min).state', 'id(bms_cell_max).state' ]
      - lambda: |-
          auto* widget = id(cell_line_chart);
          auto* obj = widget->obj;
          static lv_point_t line_points[432];
          auto sensors = id(bms_hub).get_cell_voltage_sensors();
          for(int i=0; i<108 && i<sensors.size(); i++) {
            int x = i * 9;
            float v = sensors[i]->state;
            if (std::isnan(v)) v = 0;
            // Scale 2.5V - 4.5V to 0-400px (inverted for screen Y)
            int16_t y = (int16_t)(400 - (v - 2.5f) / 2.0f * 400.0f);
            if (y < 0) y = 0;
            if (y > 400) y = 400;
            
            line_points[i*4 + 0] = {(lv_coord_t)x, 400};
            line_points[i*4 + 1] = {(lv_coord_t)x, (lv_coord_t)y};
            line_points[i*4 + 2] = {(lv_coord_t)(x+6), (lv_coord_t)y};
            line_points[i*4 + 3] = {(lv_coord_t)(x+6), 400};
          }
          lv_line_set_points(obj, line_points, 432);

sensor:
  - platform: uptime
    id: uptime_sec
    update_interval: 5s
    on_value:
      then:
        - lvgl.label.update:
            id: label_uptime
            text:
              format: "Uptime: %.0fs"
              args: [ x ]
  - platform: hmi_bms
    hmi_bms_id: bms_hub
    soc:
      name: "BMS SOC"
      id: bms_soc
      accuracy_decimals: 1
      filters:
        - throttle: 10s
      on_value:
        then:
          - script.execute:
              id: update_soc_ui
              val: !lambda "return x;"
    current:
      name: "BMS Current"
      id: bms_current
      accuracy_decimals: 3
      on_value:
        then:
          - script.execute:
              id: update_current_ui
              val: !lambda "return x;"
    battery_voltage:
      name: "BMS Battery Voltage"
      id: bms_voltage
      accuracy_decimals: 2
      on_value:
        then:
          - script.execute:
              id: update_voltage_ui
              val: !lambda "return x;"
    temperature_min:
      name: "BMS Temperature Min"
      id: bms_temp_min
      accuracy_decimals: 1
      filters:
        - throttle: 10s
      on_value:
        then:
          - script.execute: update_temp_ui
    temperature_max:
      name: "BMS Temperature Max"
      id: bms_temp_max
      accuracy_decimals: 1
      filters:
        - throttle: 10s
      on_value:
        then:
          - script.execute: update_temp_ui
    cell_voltage_min:
      name: "BMS Cell Voltage Min"
      id: bms_cell_min
      accuracy_decimals: 3
      filters:
        - throttle: 1s
      on_value:
        then:
          - script.execute: update_cells_ui
    cell_voltage_max:
      name: "BMS Cell Voltage Max"
      id: bms_cell_max
      accuracy_decimals: 3
      filters:
        - throttle: 1s
      on_value:
        then:
          - script.execute: update_cells_ui
    cell_voltages:
      - name: "Cell 001 Voltage"
        id: cell_001
        filters:
          - throttle: 1s
      - name: "Cell 002 Voltage"
        id: cell_002
        filters:
          - throttle: 1s
      - name: "Cell 003 Voltage"
        id: cell_003
        filters:
          - throttle: 1s
      - name: "Cell 004 Voltage"
        id: cell_004
        filters:
          - throttle: 1s
      - name: "Cell 005 Voltage"
        id: cell_005
        filters:
          - throttle: 1s
      - name: "Cell 006 Voltage"
        id: cell_006
        filters:
          - throttle: 1s
      - name: "Cell 007 Voltage"
        id: cell_007
        filters:
          - throttle: 1s
      - name: "Cell 008 Voltage"
        id: cell_008
        filters:
          - throttle: 1s
      - name: "Cell 009 Voltage"
        id: cell_009
        filters:
          - throttle: 1s
      - name: "Cell 010 Voltage"
        id: cell_010
        filters:
          - throttle: 1s
      - name: "Cell 011 Voltage"
        id: cell_011
        filters:
          - throttle: 1s
      - name: "Cell 012 Voltage"
        id: cell_012
        filters:
          - throttle: 1s
      - name: "Cell 013 Voltage"
        id: cell_013
        filters:
          - throttle: 1s
      - name: "Cell 014 Voltage"
        id: cell_014
        filters:
          - throttle: 1s
      - name: "Cell 015 Voltage"
        id: cell_015
        filters:
          - throttle: 1s
      - name: "Cell 016 Voltage"
        id: cell_016
        filters:
          - throttle: 1s
      - name: "Cell 017 Voltage"
        id: cell_017
        filters:
          - throttle: 1s
      - name: "Cell 018 Voltage"
        id: cell_018
        filters:
          - throttle: 1s
      - name: "Cell 019 Voltage"
        id: cell_019
        filters:
          - throttle: 1s
      - name: "Cell 020 Voltage"
        id: cell_020
        filters:
          - throttle: 1s
      - name: "Cell 021 Voltage"
        id: cell_021
        filters:
          - throttle: 1s
      - name: "Cell 022 Voltage"
        id: cell_022
        filters:
          - throttle: 1s
      - name: "Cell 023 Voltage"
        id: cell_023
        filters:
          - throttle: 1s
      - name: "Cell 024 Voltage"
        id: cell_024
        filters:
          - throttle: 1s
      - name: "Cell 025 Voltage"
        id: cell_025
        filters:
          - throttle: 1s
      - name: "Cell 026 Voltage"
        id: cell_026
        filters:
          - throttle: 1s
      - name: "Cell 027 Voltage"
        id: cell_027
        filters:
          - throttle: 1s
      - name: "Cell 028 Voltage"
        id: cell_028
        filters:
          - throttle: 1s
      - name: "Cell 029 Voltage"
        id: cell_029
        filters:
          - throttle: 1s
      - name: "Cell 030 Voltage"
        id: cell_030
        filters:
          - throttle: 1s
      - name: "Cell 031 Voltage"
        id: cell_031
        filters:
          - throttle: 1s
      - name: "Cell 032 Voltage"
        id: cell_032
        filters:
          - throttle: 1s
      - name: "Cell 033 Voltage"
        id: cell_033
        filters:
          - throttle: 1s
      - name: "Cell 034 Voltage"
        id: cell_034
        filters:
          - throttle: 1s
      - name: "Cell 035 Voltage"
        id: cell_035
        filters:
          - throttle: 1s
      - name: "Cell 036 Voltage"
        id: cell_036
        filters:
          - throttle: 1s
      - name: "Cell 037 Voltage"
        id: cell_037
        filters:
          - throttle: 1s
      - name: "Cell 038 Voltage"
        id: cell_038
        filters:
          - throttle: 1s
      - name: "Cell 039 Voltage"
        id: cell_039
        filters:
          - throttle: 1s
      - name: "Cell 040 Voltage"
        id: cell_040
        filters:
          - throttle: 1s
      - name: "Cell 041 Voltage"
        id: cell_041
        filters:
          - throttle: 1s
      - name: "Cell 042 Voltage"
        id: cell_042
        filters:
          - throttle: 1s
      - name: "Cell 043 Voltage"
        id: cell_043
        filters:
          - throttle: 1s
      - name: "Cell 044 Voltage"
        id: cell_044
        filters:
          - throttle: 1s
      - name: "Cell 045 Voltage"
        id: cell_045
        filters:
          - throttle: 1s
      - name: "Cell 046 Voltage"
        id: cell_046
        filters:
          - throttle: 1s
      - name: "Cell 047 Voltage"
        id: cell_047
        filters:
          - throttle: 1s
      - name: "Cell 048 Voltage"
        id: cell_048
        filters:
          - throttle: 1s
      - name: "Cell 049 Voltage"
        id: cell_049
        filters:
          - throttle: 1s
      - name: "Cell 050 Voltage"
        id: cell_050
        filters:
          - throttle: 1s
      - name: "Cell 051 Voltage"
        id: cell_051
        filters:
          - throttle: 1s
      - name: "Cell 052 Voltage"
        id: cell_052
        filters:
          - throttle: 1s
      - name: "Cell 053 Voltage"
        id: cell_053
        filters:
          - throttle: 1s
      - name: "Cell 054 Voltage"
        id: cell_054
        filters:
          - throttle: 1s
      - name: "Cell 055 Voltage"
        id: cell_055
        filters:
          - throttle: 1s
      - name: "Cell 056 Voltage"
        id: cell_056
        filters:
          - throttle: 1s
      - name: "Cell 057 Voltage"
        id: cell_057
        filters:
          - throttle: 1s
      - name: "Cell 058 Voltage"
        id: cell_058
        filters:
          - throttle: 1s
      - name: "Cell 059 Voltage"
        id: cell_059
        filters:
          - throttle: 1s
      - name: "Cell 060 Voltage"
        id: cell_060
        filters:
          - throttle: 1s
      - name: "Cell 061 Voltage"
        id: cell_061
        filters:
          - throttle: 1s
      - name: "Cell 062 Voltage"
        id: cell_062
        filters:
          - throttle: 1s
      - name: "Cell 063 Voltage"
        id: cell_063
        filters:
          - throttle: 1s
      - name: "Cell 064 Voltage"
        id: cell_064
        filters:
          - throttle: 1s
      - name: "Cell 065 Voltage"
        id: cell_065
        filters:
          - throttle: 1s
      - name: "Cell 066 Voltage"
        id: cell_066
        filters:
          - throttle: 1s
      - name: "Cell 067 Voltage"
        id: cell_067
        filters:
          - throttle: 1s
      - name: "Cell 068 Voltage"
        id: cell_068
        filters:
          - throttle: 1s
      - name: "Cell 069 Voltage"
        id: cell_069
        filters:
          - throttle: 1s
      - name: "Cell 070 Voltage"
        id: cell_070
        filters:
          - throttle: 1s
      - name: "Cell 071 Voltage"
        id: cell_071
        filters:
          - throttle: 1s
      - name: "Cell 072 Voltage"
        id: cell_072
        filters:
          - throttle: 1s
      - name: "Cell 073 Voltage"
        id: cell_073
        filters:
          - throttle: 1s
      - name: "Cell 074 Voltage"
        id: cell_074
        filters:
          - throttle: 1s
      - name: "Cell 075 Voltage"
        id: cell_075
        filters:
          - throttle: 1s
      - name: "Cell 076 Voltage"
        id: cell_076
        filters:
          - throttle: 1s
      - name: "Cell 077 Voltage"
        id: cell_077
        filters:
          - throttle: 1s
      - name: "Cell 078 Voltage"
        id: cell_078
        filters:
          - throttle: 1s
      - name: "Cell 079 Voltage"
        id: cell_079
        filters:
          - throttle: 1s
      - name: "Cell 080 Voltage"
        id: cell_080
        filters:
          - throttle: 1s
      - name: "Cell 081 Voltage"
        id: cell_081
        filters:
          - throttle: 1s
      - name: "Cell 082 Voltage"
        id: cell_082
        filters:
          - throttle: 1s
      - name: "Cell 083 Voltage"
        id: cell_083
        filters:
          - throttle: 1s
      - name: "Cell 084 Voltage"
        id: cell_084
        filters:
          - throttle: 1s
      - name: "Cell 085 Voltage"
        id: cell_085
        filters:
          - throttle: 1s
      - name: "Cell 086 Voltage"
        id: cell_086
        filters:
          - throttle: 1s
      - name: "Cell 087 Voltage"
        id: cell_087
        filters:
          - throttle: 1s
      - name: "Cell 088 Voltage"
        id: cell_088
        filters:
          - throttle: 1s
      - name: "Cell 089 Voltage"
        id: cell_089
        filters:
          - throttle: 1s
      - name: "Cell 090 Voltage"
        id: cell_090
        filters:
          - throttle: 1s
      - name: "Cell 091 Voltage"
        id: cell_091
        filters:
          - throttle: 1s
      - name: "Cell 092 Voltage"
        id: cell_092
        filters:
          - throttle: 1s
      - name: "Cell 093 Voltage"
        id: cell_093
        filters:
          - throttle: 1s
      - name: "Cell 094 Voltage"
        id: cell_094
        filters:
          - throttle: 1s
      - name: "Cell 095 Voltage"
        id: cell_095
        filters:
          - throttle: 1s
      - name: "Cell 096 Voltage"
        id: cell_096
        filters:
          - throttle: 1s
      - name: "Cell 097 Voltage"
        id: cell_097
        filters:
          - throttle: 1s
      - name: "Cell 098 Voltage"
        id: cell_098
        filters:
          - throttle: 1s
      - name: "Cell 099 Voltage"
        id: cell_099
        filters:
          - throttle: 1s
      - name: "Cell 100 Voltage"
        id: cell_100
        filters:
          - throttle: 1s
      - name: "Cell 101 Voltage"
        id: cell_101
        filters:
          - throttle: 1s
      - name: "Cell 102 Voltage"
        id: cell_102
        filters:
          - throttle: 1s
      - name: "Cell 103 Voltage"
        id: cell_103
        filters:
          - throttle: 1s
      - name: "Cell 104 Voltage"
        id: cell_104
        filters:
          - throttle: 1s
      - name: "Cell 105 Voltage"
        id: cell_105
        filters:
          - throttle: 1s
      - name: "Cell 106 Voltage"
        id: cell_106
        filters:
          - throttle: 1s
      - name: "Cell 107 Voltage"
        id: cell_107
        filters:
          - throttle: 1s
      - name: "Cell 108 Voltage"
        id: cell_108
        filters:
          - throttle: 1s

logger:
  baud_rate: 115200
  hardware_uart: UART0
  level: DEBUG
  logs:
    sensor: INFO

uart:
  - id: uart_bus
    tx_pin: GPIO24   #USB Negative - yes we are using the usb pins for serial UART
    rx_pin: GPIO25   #USB Positive
    baud_rate: 460800

i2c:
  - id: bus_a
    sda: GPIO7
    scl: GPIO8
    scan: true
    frequency: 400kHz

### Display
display:
  - platform: mipi_dsi
    model: JC1060P470
    id: my_display
    reset_pin:
      number: GPIO05
    update_interval: never
    hsync_pulse_width: 20

### Touchscreen
touchscreen:
  - platform: gt911
    id: my_touchscreen
    i2c_id: bus_a
    interrupt_pin: GPIO21

output:
  - id: gpio_backlight_pwm
    platform: ledc
    pin: GPIO23

light:
  - platform: monochromatic
    output: gpio_backlight_pwm
    name: Display Backlight
    icon: mdi:lightbulb-on
    id: display_backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 0s
    gamma_correct: 1.0

switch:
  - platform: gpio
    pin: GPIO11
    name: "Audio Amplifier"
    id: audio_amplifier
    restore_mode: ALWAYS_OFF

# LVGL Configuration
font:
  - file: "gfonts://Roboto"
    id: font_roboto_20
    size: 20
  - file: "gfonts://Roboto"
    id: font_roboto_40
    size: 40
  - file: "gfonts://Roboto"
    id: font_roboto_80
    size: 80

lvgl:
  id: my_lvgl
  displays: my_display
  touchscreens: my_touchscreen
  bg_color: 0x000000
  disp_bg_color: 0x000000
  buffer_size: 20%
  byte_order: little_endian
  pages:
    - id: main_page
      on_swipe_left:
        - lvgl.page.show: details_page
      widgets:
        # SOC Arc Indicator
        - arc:
            id: soc_arc
            width: 340
            height: 340
            align: TOP_LEFT
            x: 40
            y: 40
            min_value: 0
            max_value: 100
            bg_color: 0x1A1A1A
            widgets:
              - label:
                  id: label_soc
                  text: " "
                  align: CENTER
                  text_font: font_roboto_80
                  text_color: 0xFFFFFF
              - label:
                  text: "SOC"
                  align: CENTER
                  y: 50
                  text_font: font_roboto_20
                  text_color: 0xAAAAAA

        # Main Data (Right Side)
        - label:
            id: label_voltage
            text: " "
            align: TOP_RIGHT
            x: -60
            y: 70
            text_font: font_roboto_80
            text_color: 0x00BFFF # DeepSkyBlue

        - label:
            id: label_current
            text: " "
            align: TOP_RIGHT
            x: -60
            y: 190
            text_font: font_roboto_80
            text_color: 0xFFA500 # Orange

        # Divider
        - obj:
            width: 90%
            height: 2
            align: BOTTOM_MID
            y: -140
            bg_color: 0x333333

        # Statistics Grid (Bottom)
        - label:
            text: "TEMPERATURE"
            align: BOTTOM_LEFT
            x: 60
            y: -90
            text_font: font_roboto_20
            text_color: 0x888888
        - label:
            id: label_temp
            text: " "
            align: BOTTOM_LEFT
            x: 60
            y: -40
            text_font: font_roboto_40
            text_color: 0xFFFFFF

        - label:
            text: "CELL VOLTAGES"
            align: BOTTOM_RIGHT
            x: -60
            y: -90
            text_font: font_roboto_20
            text_color: 0x888888
        - label:
            id: label_cells
            text: " "
            align: BOTTOM_RIGHT
            x: -60
            y: -40
            text_font: font_roboto_40
            text_color: 0xFFFFFF

        # Uptime (Verify UI is alive)
        - label:
            id: label_uptime
            text: "Uptime: --s"
            align: BOTTOM_MID
            y: -10
            text_font: font_roboto_20
            text_color: 0x444444

    - id: details_page
      on_swipe_right:
        - lvgl.page.show: main_page
      widgets:
        - label:
            text: "INDIVIDUAL CELL VOLTAGES"
            align: TOP_MID
            y: 20
            text_font: font_roboto_40
            text_color: 0xAAAAAA

        - line:
            id: cell_line_chart
            width: 972 # 108 * 9
            height: 400
            align: CENTER
            y: 20
            line_width: 2
            line_color: 0x00FF00
            points:
              - 0, 400
              - 972, 400

        - label:
            text: "← Swipe right to return"
            align: BOTTOM_MID
            y: -20
            text_font: font_roboto_20
            text_color: 0x666666
